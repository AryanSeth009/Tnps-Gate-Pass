<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hostel Intelligence Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sidebar-width: 260px; --primary-color: #4e73df; --dark-bg: #1a1c23; }
        body { background-color: #f8f9fc; font-family: 'Inter', sans-serif; }
        
        /* Sidebar Design */
        .sidebar { width: var(--sidebar-width); background: var(--dark-bg); height: 100vh; position: fixed; color: white; padding: 1.5rem; }
        .main-content { margin-left: var(--sidebar-width); padding: 2rem; }
        
        /* Card & UI Components */
        .glass-card { background: white; border: none; border-radius: 1rem; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); padding: 1.5rem; height: 100%; }
        .kpi-card { border-left: 0.25rem solid; transition: transform 0.2s; }
        .kpi-card:hover { transform: scale(1.02); }
        
        .text-xs { font-size: .7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
        .chart-heading { font-weight: 700; color: #5a5c69; margin-bottom: 1.5rem; display: flex; align-items: center; }
    </style>
</head>
<body>

<div class="sidebar d-none d-lg-block">
    <h4 class="fw-bold mb-5"><i class="fas fa-university me-2"></i> SVPCET</h4>
    <nav class="nav flex-column gap-3">
        <a href="/daterange" class="nav-link text-white-50 p-0"><i class="fas fa-home me-2"></i> Home</a>
        <a href="#" class="nav-link text-white p-0 active"><i class="fas fa-chart-pie me-2"></i> Dashboard</a>
        <a href="/attendance" class="nav-link text-white-50 p-0"><i class="fas fa-th me-2"></i> Attendance Grid</a>
    </nav>
</div>

<div class="main-content">
    <header class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h2 class="fw-bold text-dark mb-0">System Analytics</h2>
            <p class="text-muted small">Real-time status for 14 Jan 2026</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-white shadow-sm" onclick="window.print()"><i class="fas fa-download me-2"></i>Report</button>
            <span class="badge bg-primary rounded-pill p-2 px-3">Role: <%= role %></span>
        </div>
    </header>

    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6">
            <div class="glass-card kpi-card border-primary">
                <div class="text-xs text-primary mb-1">Total Hostel Students</div>
                <div class="h3 mb-0 fw-bold"><%= stats.students.total %></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="glass-card kpi-card border-success">
                <div class="text-xs text-success mb-1">In Hostel Today</div>
                <div class="h3 mb-0 fw-bold"><%= stats.attendance.find(a => a.status === 'Present')?.count || 0 %></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="glass-card kpi-card border-warning">
                <div class="text-xs text-warning mb-1">Pending Passes</div>
                <div class="h3 mb-0 fw-bold"><%= stats.requests.find(r => r.status === 'pending')?.count || 0 %></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="glass-card kpi-card border-danger">
                <div class="text-xs text-danger mb-1">Medical (Sick)</div>
                <div class="h3 mb-0 fw-bold"><%= stats.sick.reduce((acc, curr) => acc + curr.count, 0) %></div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="glass-card">
                <div class="chart-heading"><i class="fas fa-bolt text-primary me-2"></i> Hourly Gate Movement</div>
                <canvas id="gateChart" height="120"></canvas>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="glass-card">
                <div class="chart-heading"><i class="fas fa-utensils text-danger me-2"></i> Mess Utilization</div>
                <canvas id="messChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="glass-card">
                <div class="chart-heading"><i class="fas fa-building text-info me-2"></i> Block Occupancy</div>
                <canvas id="blockChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="glass-card">
                <div class="chart-heading"><i class="fas fa-virus text-warning me-2"></i> Illness Distribution</div>
                <canvas id="sickChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="glass-card">
                <div class="chart-heading"><i class="fas fa-check-circle text-success me-2"></i> Attendance Summary</div>
                <canvas id="attChart"></canvas>
            </div>
        </div>
    </div>
</div>



<script>
    const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'];

    // Hourly Movement Line Chart
    new Chart(document.getElementById('gateChart'), {
        type: 'line',
        data: {
            labels: <%- JSON.stringify(stats.gateTrend.map(d => d.hour + ":00")) %>,
            datasets: [{
                label: 'Student Movement',
                data: <%- JSON.stringify(stats.gateTrend.map(d => d.count)) %>,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                fill: true,
                tension: 0.4
            }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });

    // Mess Donut
    new Chart(document.getElementById('messChart'), {
        type: 'doughnut',
        data: {
            labels: <%- JSON.stringify(stats.mess.map(m => m.mess_type)) %>,
            datasets: [{ data: <%- JSON.stringify(stats.mess.map(m => m.count)) %>, backgroundColor: ['#1cc88a', '#e74a3b'] }]
        },
        options: { cutout: '70%' }
    });

    // Block Bar
    new Chart(document.getElementById('blockChart'), {
        type: 'bar',
        data: {
            labels: <%- JSON.stringify(stats.blocks.map(b => b.label)) %>,
            datasets: [{ label: 'Students', data: <%- JSON.stringify(stats.blocks.map(b => b.count)) %>, backgroundColor: '#36b9cc', borderRadius: 5 }]
        }
    });

    // Attendance Pie
    new Chart(document.getElementById('attChart'), {
        type: 'pie',
        data: {
            labels: <%- JSON.stringify(stats.attendance.map(a => a.status)) %>,
            datasets: [{ data: <%- JSON.stringify(stats.attendance.map(a => a.count)) %>, backgroundColor: colors }]
        }
    });

    // Sick Pie
    new Chart(document.getElementById('sickChart'), {
        type: 'pie',
        data: {
            labels: <%- JSON.stringify(stats.sick.map(s => s.illness)) %>,
            datasets: [{ data: <%- JSON.stringify(stats.sick.map(s => s.count)) %>, backgroundColor: ['#f6c23e', '#e74a3b', '#4e73df'] }]
        }
    });
</script>
</body>
</html>