<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Dashboard | SVPCET</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --brand: #6366f1; --bg: #f8fafc; --card-border: #f1f5f9; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); overflow: hidden; color: #1e293b; }
        
        .sidebar { width: 260px; height: 100vh; position: fixed; background: #0f172a; padding: 2rem 1.5rem; z-index: 100; }
        .main-wrapper { margin-left: 260px; height: 100vh; overflow-y: auto; padding: 2.5rem 3.5rem; }

        .elite-card { background: #fff; border: 1px solid var(--card-border); border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); height: 100%; transition: 0.3s; }
        .elite-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .stat-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 2rem; font-weight: 800; margin: 0.25rem 0; }

        .chart-box { height: 350px; width: 100%; position: relative; }
        
        .nav-link { color: #94a3b8; padding: 0.8rem 1rem; border-radius: 10px; margin-bottom: 0.5rem; transition: 0.3s; }
        .nav-link.active { background: rgba(99, 102, 241, 0.15); color: #fff; }
        .nav-link:hover { color: #fff; }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="mb-5 px-2 text-white">
        <h4 class="fw-bold"><i class="fas fa-university me-2 text-indigo"></i>SVPCET</h4>
    </div>
    <nav class="nav flex-column">
        <a href="/daterange" class="nav-link"><i class="fas fa-home me-2"></i> Home</a>
        <a href="#" class="nav-link active"><i class="fas fa-chart-pie me-2"></i> Dashboard</a>
        <a href="/attendance" class="nav-link"><i class="fas fa-user-check me-2"></i> Attendance</a>
        <a href="/logout" class="nav-link text-danger mt-5"><i class="fas fa-sign-out-alt me-2"></i> Sign Out</a>
    </nav>
</aside>

<main class="main-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h2 class="fw-bold m-0 text-dark">Hostel Analytics</h2>
            <p class="text-muted">Live Operational Control Center</p>
        </div>
        <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill px-3 py-2">
            Admin: <%= role %>
        </span>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="elite-card" style="border-top: 4px solid #6366f1;">
                <div class="stat-label">Resident Students</div>
                <div class="stat-value"><%= data.total %></div>
                <div class="small text-muted">Total Registered</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="elite-card" style="border-top: 4px solid #10b981;">
                <div class="stat-label">In-Hostel Now</div>
                <div class="stat-value text-success"><%= data.present %></div>
                <div class="small text-muted">Based on Today's Roll-call</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="elite-card" style="border-top: 4px solid #3b82f6;">
                <div class="stat-label">Active City Passes</div>
                <div class="stat-value text-primary"><%= data.cityPass %></div>
                <div class="small text-muted">Currently out in City</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="elite-card" style="border-top: 4px solid #8b5cf6;">
                <div class="stat-label">Active Home Passes</div>
                <div class="stat-value text-purple" style="color: #8b5cf6;"><%= data.homePass %></div>
                <div class="small text-muted">Leaves/Overnight</div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="elite-card">
                <h6 class="fw-bold mb-4">Attendance Status Distribution</h6>
                <div class="chart-box">
                    <canvas id="attBarChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="elite-card">
                <h6 class="fw-bold mb-4">Mess Type Split</h6>
                <div class="chart-box">
                    <canvas id="messDonutChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="elite-card">
                <h6 class="fw-bold mb-4">Block Occupancy Overview</h6>
                <div class="chart-box" style="height: 280px;">
                    <canvas id="blockChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="elite-card text-center">
                <h6 class="fw-bold mb-4">Health Alerts Today</h6>
                <div class="py-4">
                    <h1 class="display-2 fw-bold text-danger"><%= data.sick %></h1>
                    <p class="text-muted">New medical logs recorded today</p>
                    <i class="fas fa-heartbeat fa-3x text-danger-emphasis opacity-25"></i>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const attRaw = <%- JSON.stringify(data.attendanceRaw) %>;
    const messRaw = <%- JSON.stringify(data.messRaw) %>;
    const blockRaw = <%- JSON.stringify(data.blocks) %>;

    // 1. Attendance Bar Chart
    new Chart(document.getElementById('attBarChart'), {
        type: 'bar',
        data: {
            labels: attRaw.map(a => a.status),
            datasets: [{
                label: 'Student Count',
                data: attRaw.map(a => a.count),
                backgroundColor: '#6366f1',
                borderRadius: 8,
                barThickness: 50
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { display: false } },
            scales: { 
                y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, 
                x: { grid: { display: false } } 
            }
        }
    });

    // 2. Mess Donut Chart
    new Chart(document.getElementById('messDonutChart'), {
        type: 'doughnut',
        data: {
            labels: messRaw.map(m => m.mess_type),
            datasets: [{
                data: messRaw.map(m => m.count),
                backgroundColor: ['#10b981', '#f43f5e'],
                borderWidth: 0,
                hoverOffset: 15
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            cutout: '75%', 
            plugins: { legend: { position: 'bottom' } } 
        }
    });

    // 3. Block Bar Chart
    new Chart(document.getElementById('blockChart'), {
        type: 'bar',
        data: {
            labels: blockRaw.map(b => b.label),
            datasets: [{
                label: 'Students',
                data: blockRaw.map(b => b.count),
                backgroundColor: '#3b82f6',
                borderRadius: 6
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
</script>

</body>
</html>
